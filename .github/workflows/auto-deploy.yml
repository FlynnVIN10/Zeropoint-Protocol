name: Auto Deploy to Cloudflare Pages
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: iaai/package-lock.json

      - name: Build Dynamic Evidence
        run: |
          echo "Building dynamic evidence files..."
          if ! node scripts/build-dynamic-evidence.mjs; then
            echo "❌ CRITICAL: Dynamic evidence build failed"
            echo "Deployment blocked - evidence files must be generated successfully"
            exit 1
          fi
          echo "✅ Dynamic evidence build completed successfully"
          
          # Verify critical evidence files exist
          echo "Verifying evidence files..."
          if [ ! -f "public/build-info.json" ] || [ ! -f "evidence/training/latest.json" ] || [ ! -f "evidence/petals/status.json" ] || [ ! -f "evidence/wondercraft/status.json" ]; then
            echo "❌ CRITICAL: Required evidence files missing"
            echo "Deployment blocked - all evidence files must be present"
            exit 1
          fi
          
          # Verify evidence files contain valid JSON
          echo "Validating evidence file JSON..."
          if ! jq empty public/build-info.json 2>/dev/null; then
            echo "❌ CRITICAL: public/build-info.json contains invalid JSON"
            exit 1
          fi
          if ! jq empty evidence/training/latest.json 2>/dev/null; then
            echo "❌ CRITICAL: evidence/training/latest.json contains invalid JSON"
            exit 1
          fi
          if ! jq empty evidence/petals/status.json 2>/dev/null; then
            echo "❌ CRITICAL: evidence/petals/status.json contains invalid JSON"
            exit 1
          fi
          if ! jq empty evidence/wondercraft/status.json 2>/dev/null; then
            echo "❌ CRITICAL: evidence/wondercraft/status.json contains invalid JSON"
            exit 1
          fi
          
          echo "✅ All evidence files validated successfully"
      - name: Validate SCP schema presence
        run: test -f evidence/schemas/metrics.schema.json

      - name: Validate evidence
        run: node scripts/build-dynamic-evidence.mjs --validate

      - name: Build leaderboard
        run: node scripts/build-leaderboard.mjs

      - name: Fail if placeholders
        run: if grep -R "__BUILD_" -n public evidence; then echo "Placeholders detected"; exit 1; fi


      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: zeropoint-protocol
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Deployment notification
        run: |
          echo "## Auto-Deployment Status 🚀" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Automatically deployed to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Zeroth Principle:** Good intent and good heart, or the system doesn't function." >> $GITHUB_STEP_SUMMARY

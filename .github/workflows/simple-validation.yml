name: Simple Validation (Static Files + API)
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  validation:
    name: Validate Static Files and API
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check required files exist
        run: |
          echo "## File Validation ðŸ“" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if required static files exist
          REQUIRED_FILES=(
            "public/index.html"
            "public/api/healthz.json"
            "public/api/readyz.json"
            "functions/api/healthz.js"
            "functions/api/readyz.js"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Missing: $file" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done

      - name: Validate JSON files
        run: |
          echo "## JSON Validation ðŸ”" >> $GITHUB_STEP_SUMMARY
          
          # Check if JSON files are valid
          for json_file in public/api/*.json; do
            if [ -f "$json_file" ]; then
              if jq empty "$json_file" 2>/dev/null; then
                echo "âœ… Valid JSON: $json_file" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Invalid JSON: $json_file" >> $GITHUB_STEP_SUMMARY
                exit 1
              fi
            fi
          done

      - name: Check website status
        run: |
          echo "## Website Status Check ðŸŒ" >> $GITHUB_STEP_SUMMARY
          
          # Wait a moment for any recent deployments
          sleep 10
          
          # Check if the website is accessible
          if curl -fsS "https://zeropoint-protocol.pages.dev/api/healthz" >/dev/null 2>&1; then
            echo "âœ… Website is accessible" >> $GITHUB_STEP_SUMMARY
            
            # Get current commit from website
            WEBSITE_COMMIT=$(curl -fsS "https://zeropoint-protocol.pages.dev/api/healthz" | jq -r '.commit' 2>/dev/null || echo "unknown")
            LOCAL_COMMIT="${{ github.sha }}"
            
            echo "**Website commit:** $WEBSITE_COMMIT" >> $GITHUB_STEP_SUMMARY
            echo "**Local commit:** $LOCAL_COMMIT" >> $GITHUB_STEP_SUMMARY
            
            if [ "$WEBSITE_COMMIT" = "$LOCAL_COMMIT" ]; then
              echo "âœ… Website shows current commit" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Website shows different commit (may need deployment)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Website is not accessible" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Final status
        run: |
          echo "## Validation Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** All static files and API endpoints validated successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:** Manual Cloudflare Pages deployment may be required" >> $GITHUB_STEP_SUMMARY
          echo "**Zeroth Principle:** Good intent and good heart, or the system doesn't function." >> $GITHUB_STEP_SUMMARY

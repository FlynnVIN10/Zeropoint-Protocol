name: Consensus Gate (Dual)

on:
  pull_request:
    branches: [ main ]

jobs:
  check_consensus:
    runs-on: ubuntu-latest
    steps:
      - name: Extract proposalId from PR body
        id: extract
        run: |
          body="${{ github.event.pull_request.body }}"
          # Expect a line like: proposalId: abc123
          pid=$(printf "%s" "$body" | grep -Eo 'proposalId:\s*[A-Za-z0-9_-]+' | awk '{print $2}')
          if [ -z "$pid" ]; then
            echo "No proposalId found in PR body. Add 'proposalId: <value>' line."
            exit 1
          fi
          echo "proposalId=$pid" >> $GITHUB_OUTPUT

      - name: Check consensus via API
        run: |
          set -e
          PID="${{ steps.extract.outputs.proposalId }}"
          # Replace with actual host if needed:
          API_BASE="https://zeropointprotocol.ai"
          json=$(curl -fsS "$API_BASE/api/proposals/$PID/consensus")
          ai=$(echo "$json" | jq -r '.consensus.ai')
          human=$(echo "$json" | jq -r '.consensus.human')
          echo "AI: $ai  HUMAN: $human"
          if [ "$ai" != "pass" ] || [ "$human" != "pass" ]; then
            echo "❌ Dual Consensus not satisfied (ai=$ai, human=$human)."
            exit 1
          fi
          echo "✅ Dual Consensus satisfied."

name: Post-Merge Production Verification

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

env:
  PROD_URL: https://zeropointprotocol.ai
  NODE_VERSION: '20'

jobs:
  probes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify production endpoints
        run: |
          set -e
          echo "## Production Endpoint Verification 🔍" >> $GITHUB_STEP_SUMMARY
          echo "**Current Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          
          # Test all critical endpoints
          echo "Testing /api/healthz..." >> $GITHUB_STEP_SUMMARY
          curl -sS -D - https://zeropointprotocol.ai/api/healthz -o healthz.json
          jq -e 'type=="object"' healthz.json >/dev/null
          echo "✅ /api/healthz: 200 OK" >> $GITHUB_STEP_SUMMARY
          
          echo "Testing /api/readyz..." >> $GITHUB_STEP_SUMMARY
          curl -sS -D - https://zeropointprotocol.ai/api/readyz -o readyz.json
          jq -e 'type=="object"' readyz.json >/dev/null
          echo "✅ /api/readyz: 200 OK" >> $GITHUB_STEP_SUMMARY
          
          echo "Testing /status/version.json..." >> $GITHUB_STEP_SUMMARY
          curl -sS -D - https://zeropointprotocol.ai/status/version.json -o version.json
          jq -e 'type=="object"' version.json >/dev/null
          echo "✅ /status/version.json: 200 OK" >> $GITHUB_STEP_SUMMARY
          
          echo "Testing /api/training/status..." >> $GITHUB_STEP_SUMMARY
          curl -sS -D - https://zeropointprotocol.ai/api/training/status -o training.json
          jq -e 'type=="object"' training.json >/dev/null
          echo "✅ /api/training/status: 200 OK" >> $GITHUB_STEP_SUMMARY
          
          echo "Testing /petals/status.json..." >> $GITHUB_STEP_SUMMARY
          curl -sS -D - https://zeropointprotocol.ai/petals/status.json -o petals.json
          jq -e 'type=="object"' petals.json >/dev/null
          echo "✅ /petals/status.json: 200 OK" >> $GITHUB_STEP_SUMMARY
          
          echo "Testing /api/wondercraft/status.json..." >> $GITHUB_STEP_SUMMARY
          curl -sS -D - https://zeropointprotocol.ai/api/wondercraft/status.json -o wondercraft.json
          jq -e 'type=="object"' wondercraft.json >/dev/null
          echo "✅ /api/wondercraft/status.json: 200 OK" >> $GITHUB_STEP_SUMMARY
          
          echo "🎉 All production endpoints verified successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Verify dynamic evidence system
        run: |
          echo "## Dynamic Evidence Verification 🔄" >> $GITHUB_STEP_SUMMARY
          
          # Check if evidence files exist and are dynamic
          if [ -f "evidence/training/latest.json" ]; then
            echo "✅ evidence/training/latest.json exists" >> $GITHUB_STEP_SUMMARY
            echo "Content:" >> $GITHUB_STEP_SUMMARY
            cat evidence/training/latest.json >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ evidence/training/latest.json missing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ -f "public/build-info.json" ]; then
            echo "✅ public/build-info.json exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ public/build-info.json missing" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: production-verification
          path: evidence/prod
